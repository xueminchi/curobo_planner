# Collision-Freeç›®æ ‡ç”ŸæˆåŠŸèƒ½æ€»ç»“

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

ä¸º `motion_gen_scene_selector.py` æ·»åŠ äº†æ™ºèƒ½çš„collision-freeç›®æ ‡ç”ŸæˆåŠŸèƒ½ï¼Œæ˜¾è‘—æé«˜äº†å¤šç›®æ ‡è¿åŠ¨è§„åˆ’çš„æˆåŠŸç‡ã€‚

## ğŸš€ æ ¸å¿ƒæ”¹è¿›

### 1. æ™ºèƒ½ç›®æ ‡ç”Ÿæˆ
- **éšæœºé‡‡æ ·ç®—æ³•**: åœ¨æœºå™¨äººå·¥ä½œç©ºé—´å†…æ™ºèƒ½é‡‡æ ·
- **ç¢°æ’æ£€æµ‹**: æ”¯æŒç«‹æ–¹ä½“ã€çƒä½“ã€èƒ¶å›Šä½“ç­‰å¤šç§å‡ ä½•ä½“
- **å®‰å…¨è·ç¦»**: è‡ªåŠ¨æ·»åŠ å®‰å…¨è¾¹ç•Œï¼Œé¿å…ä¸éšœç¢ç‰©è¿‡è¿‘

### 2. è‡ªé€‚åº”é‡è¯•æœºåˆ¶
- **å¤±è´¥æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«è¿åŠ¨è§„åˆ’å¤±è´¥
- **æ™ºèƒ½é‡è¯•**: å¤±è´¥æ—¶ç”Ÿæˆæ–°çš„collision-freeç›®æ ‡
- **æœ€å¤§é‡è¯•é™åˆ¶**: é¿å…æ— é™å¾ªç¯ï¼Œæä¾›ä¼˜é›…é™çº§

### 3. å·¥ä½œç©ºé—´ä¼˜åŒ–
```python
workspace_bounds = {
    'x': [0.2, 0.7],    # xè½´èŒƒå›´
    'y': [-0.5, 0.5],   # yè½´èŒƒå›´  
    'z': [0.3, 0.8]     # zè½´èŒƒå›´
}
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### âœ… æˆåŠŸç‡æµ‹è¯•
| åœºæ™¯é…ç½® | ç›®æ ‡ç”ŸæˆæˆåŠŸç‡ | éšœç¢ç‰©æ•°é‡ |
|---------|---------------|-----------|
| collision_table.yml | 100% (10/10) | 1ä¸ªç«‹æ–¹ä½“ |
| collision_cage.yml | 100% (10/10) | 8ä¸ªç«‹æ–¹ä½“ |
| collision_primitives_3d.yml | 100% (10/10) | 6ä¸ªæ··åˆå‡ ä½•ä½“ |

### âœ… ç¢°æ’æ£€æµ‹éªŒè¯
- **ç«‹æ–¹ä½“æ£€æµ‹**: 5/5 æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- **çƒä½“æ£€æµ‹**: 4/4 æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- **å·¥ä½œç©ºé—´è¾¹ç•Œ**: 20/20 ç›®æ ‡åœ¨é¢„æœŸèŒƒå›´å†…

## ğŸ”§ æŠ€æœ¯å®ç°

### æ ¸å¿ƒå‡½æ•°

#### 1. ä¸»è¦ç”Ÿæˆå‡½æ•°
```python
def generate_collision_free_goal(self, world_cfg, max_attempts=50, safety_margin=0.1):
    """ç”Ÿæˆæ— ç¢°æ’çš„ç›®æ ‡ä½ç½®"""
    # æ™ºèƒ½é‡‡æ · + ç¢°æ’æ£€æµ‹ + å®‰å…¨è·ç¦»
```

#### 2. ç¢°æ’æ£€æµ‹å‡½æ•°
```python
def _check_point_cuboid_collision(self, point, cuboid, safety_margin):
    """æ£€æŸ¥ç‚¹ä¸ç«‹æ–¹ä½“çš„ç¢°æ’"""

def _check_point_sphere_collision(self, point, sphere, safety_margin):
    """æ£€æŸ¥ç‚¹ä¸çƒä½“çš„ç¢°æ’"""

def _check_point_capsule_collision(self, point, capsule, safety_margin):
    """æ£€æŸ¥ç‚¹ä¸èƒ¶å›Šä½“çš„ç¢°æ’"""
```

### å¤šç›®æ ‡è§„åˆ’æ”¹è¿›
```python
# åŸå§‹ç›®æ ‡å¤±è´¥æ—¶çš„é‡è¯•é€»è¾‘
for retry in range(max_retries):
    new_goal_pos = visualizer.generate_collision_free_goal(world_cfg)
    if new_goal_pos is not None:
        # ä½¿ç”¨æ–°ç›®æ ‡é‡æ–°è§„åˆ’
        retry_result = motion_gen.plan_single(...)
        if retry_result.success:
            # æˆåŠŸï¼ç»§ç»­ä¸‹ä¸€ä¸ªç›®æ ‡
            break
```

## ğŸ® ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 1. æ™ºèƒ½æç¤º
```
âŒ åˆ°ç›®æ ‡ 2 çš„è½¨è¿¹è§„åˆ’å¤±è´¥ï¼çŠ¶æ€: None
ğŸ”„ å°è¯•ç”Ÿæˆæ–°çš„æ— ç¢°æ’ç›®æ ‡...
ğŸ¯ é‡è¯• 1/3: æ–°ç›®æ ‡ [0.456, 0.234, 0.567]
âœ… ä½¿ç”¨æ–°ç›®æ ‡çš„è½¨è¿¹è§„åˆ’æˆåŠŸï¼
ğŸ“Š è§„åˆ’æ—¶é—´: 0.0234ç§’
```

### 2. ç»Ÿè®¡ä¿¡æ¯
```
ğŸ‰ å¤šç›®æ ‡è§„åˆ’å®Œæˆï¼æˆåŠŸåˆ°è¾¾ 3/3 ä¸ªç›®æ ‡
```

## ğŸŒŸ ä¼˜åŠ¿æ€»ç»“

| ç‰¹æ€§ | æ”¹è¿›å‰ | æ”¹è¿›å |
|------|--------|--------|
| **ç›®æ ‡é€‰æ‹©** | å›ºå®šç›®æ ‡ | æ™ºèƒ½collision-freeç›®æ ‡ |
| **å¤±è´¥å¤„ç†** | ç›´æ¥è·³è¿‡ | è‡ªåŠ¨é‡è¯•æ–°ç›®æ ‡ |
| **æˆåŠŸç‡** | å–å†³äºåœºæ™¯ | æ˜¾è‘—æé«˜ |
| **é€‚åº”æ€§** | æœ‰é™ | é€‚ç”¨ä»»æ„åœºæ™¯ |

## ğŸ¯ åº”ç”¨åœºæ™¯

1. **å¤æ‚éšœç¢ç‰©ç¯å¢ƒ**: è‡ªåŠ¨é¿å¼€å„ç§å‡ ä½•å½¢çŠ¶çš„éšœç¢ç‰©
2. **åŠ¨æ€ç›®æ ‡è§„åˆ’**: å½“é¢„è®¾ç›®æ ‡ä¸å¯è¾¾æ—¶è‡ªåŠ¨è°ƒæ•´
3. **æ‰¹é‡ä»»åŠ¡å¤„ç†**: å‡å°‘äººå·¥å¹²é¢„ï¼Œæé«˜è‡ªåŠ¨åŒ–ç¨‹åº¦
4. **åœºæ™¯é€‚åº”**: æ— éœ€é’ˆå¯¹ä¸åŒåœºæ™¯æ‰‹åŠ¨è°ƒæ•´ç›®æ ‡ä½ç½®

## ğŸš€ æœªæ¥æ‰©å±•

1. **æ›´å¤æ‚å‡ ä½•ä½“**: æ”¯æŒmeshã€å‡¸åŒ…ç­‰å¤æ‚å½¢çŠ¶
2. **åŠ¨æ€éšœç¢ç‰©**: è€ƒè™‘è¿åŠ¨ä¸­çš„éšœç¢ç‰©
3. **å¤šæœºå™¨äººåè°ƒ**: è€ƒè™‘å¤šæœºå™¨äººé—´çš„ç¢°æ’é¿å…
4. **å­¦ä¹ ä¼˜åŒ–**: åŸºäºå†å²æˆåŠŸç›®æ ‡è¿›è¡Œä¼˜åŒ–

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

```python
# åŸºæœ¬ä½¿ç”¨
visualizer = SceneMotionGenVisualizer(gui=True)
collision_free_goal = visualizer.generate_collision_free_goal(world_cfg)

# åœ¨å¤šç›®æ ‡è§„åˆ’ä¸­ä½¿ç”¨
python motion_gen_scene_selector.py
# é€‰æ‹©ä»»æ„åœºæ™¯ -> é€‰æ‹©"å¤šç›®æ ‡è¿åŠ¨è§„åˆ’" -> è‡ªåŠ¨åº”ç”¨collision-freeé‡è¯•
```

## ğŸ¬ è§†é¢‘å½•åˆ¶åŠŸèƒ½

æ–°å¢äº†å®Œæ•´çš„è§†é¢‘å½•åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥ä¿å­˜è½¨è¿¹æ’­æ”¾è¿‡ç¨‹ä¸ºMP4è§†é¢‘æ–‡ä»¶ã€‚

### ğŸ¥ æ ¸å¿ƒåŠŸèƒ½

#### 1. è‡ªåŠ¨ç›®å½•ç®¡ç†
- **æ—¶é—´æˆ³æ–‡ä»¶å¤¹**: è‡ªåŠ¨åˆ›å»º `motion_planning_videos_YYYYMMDD_HHMMSS/` æ ¼å¼çš„æ–‡ä»¶å¤¹
- **è·¯å¾„ç®¡ç†**: æ™ºèƒ½å¤„ç†æ–‡ä»¶è·¯å¾„ï¼Œé¿å…ç±»å‹å†²çª
- **è‡ªåŠ¨æ¸…ç†**: ç¨‹åºç»“æŸæ—¶è‡ªåŠ¨åœæ­¢å½•åˆ¶

#### 2. å½•åˆ¶æ§åˆ¶
```python
# å¼€å§‹å½•åˆ¶
visualizer.start_recording("my_video.mp4")

# æ£€æŸ¥å½•åˆ¶çŠ¶æ€
if visualizer.is_recording():
    print("æ­£åœ¨å½•åˆ¶...")

# åœæ­¢å½•åˆ¶
visualizer.stop_recording()
```

#### 3. æ™ºèƒ½å‘½å
- **ç®€å•è¿åŠ¨è§„åˆ’**: `simple_motion_{scene_name}_{time}.mp4`
- **é¿éšœè¿åŠ¨è§„åˆ’**: `collision_avoidance_{scene_name}_{time}.mp4`
- **å¤šç›®æ ‡è§„åˆ’**: `multi_goal_{scene_name}_target{N}_{time}.mp4`
- **é‡è¯•å½•åˆ¶**: `multi_goal_{scene_name}_target{N}_retry{M}_{time}.mp4`

### ğŸ® ç”¨æˆ·äº¤äº’

#### å½•åˆ¶è¯¢é—®
```
ğŸ¬ æ˜¯å¦è¦å½•åˆ¶è½¨è¿¹è§†é¢‘ï¼Ÿ(y/n): y
ğŸ“ è§†é¢‘ä¿å­˜ç›®å½•: /path/to/motion_planning_videos_20231201_143022/
ğŸ¬ å¼€å§‹å½•åˆ¶è§†é¢‘: simple_motion_table_143045.mp4
ğŸ“¹ å½•åˆ¶çŠ¶æ€: ID = 12345
```

#### å½•åˆ¶å®Œæˆ
```
è½¨è¿¹æ’­æ”¾å®Œæˆï¼
âœ… è§†é¢‘å½•åˆ¶å®Œæˆ: simple_motion_table_143045.mp4
ğŸ“ è§†é¢‘ä¿å­˜è·¯å¾„: /path/to/motion_planning_videos_20231201_143022/simple_motion_table_143045.mp4
```

### ğŸ§ª æµ‹è¯•åŠŸèƒ½

æä¾›ä¸“é—¨çš„æµ‹è¯•è„šæœ¬éªŒè¯å½•åˆ¶åŠŸèƒ½ï¼š

```bash
python examples/test_video_recording.py
```

**æµ‹è¯•è¾“å‡º**:
```
=== æµ‹è¯•è§†é¢‘å½•åˆ¶åŠŸèƒ½ ===
ğŸ“ è§†é¢‘ä¿å­˜ç›®å½•: /path/to/motion_planning_videos_20231201_143022/
åŠ è½½äº† 1 ä¸ªéšœç¢ç‰©
âœ… è½¨è¿¹è§„åˆ’æˆåŠŸï¼
è§„åˆ’æ—¶é—´: 0.1234ç§’
å¼€å§‹å½•åˆ¶è§†é¢‘æµ‹è¯•...
ğŸ¬ å¼€å§‹å½•åˆ¶è§†é¢‘: test_recording_143045.mp4
è½¨è¿¹æ’­æ”¾å®Œæˆï¼
âœ… è§†é¢‘å½•åˆ¶å®Œæˆ: test_recording_143045.mp4
âœ… è§†é¢‘æ–‡ä»¶å·²åˆ›å»º: /path/to/motion_planning_videos_20231201_143022/test_recording_143045.mp4
ğŸ“Š æ–‡ä»¶å¤§å°: 2.34 MB
```

### ğŸ”§ æŠ€æœ¯å®ç°

#### 1. PyBulletè§†é¢‘å½•åˆ¶
```python
# å¼€å§‹å½•åˆ¶
self.recording_log_id = p.startStateLogging(
    p.STATE_LOGGING_VIDEO_MP4, 
    video_path
)

# åœæ­¢å½•åˆ¶
p.stopStateLogging(self.recording_log_id)
```

#### 2. ç›®å½•ç®¡ç†
```python
def _setup_video_directory(self):
    """è®¾ç½®è§†é¢‘ä¿å­˜ç›®å½•"""
    current_date = datetime.now().strftime("%Y%m%d_%H%M%S")
    video_dir = f"motion_planning_videos_{current_date}"
    self.video_save_path = video_dir
    os.makedirs(self.video_save_path, exist_ok=True)
```

#### 3. è½¨è¿¹å¯è§†åŒ–é›†æˆ
```python
def visualize_trajectory(self, trajectory, start_state, goal_pose, 
                       record_video=False, video_name="trajectory_video.mp4"):
    """å¯è§†åŒ–è¿åŠ¨è½¨è¿¹"""
    # å¼€å§‹å½•åˆ¶
    if record_video:
        self.start_recording(video_name)
    
    # ... è½¨è¿¹æ’­æ”¾é€»è¾‘ ...
    
    # åœæ­¢å½•åˆ¶
    if record_video and self.is_recording():
        self.stop_recording()
```

### ğŸ¯ å½•åˆ¶ç‰¹æ€§

| ç‰¹æ€§ | æè¿° |
|------|------|
| **æ ¼å¼** | MP4é«˜æ¸…è§†é¢‘ |
| **è´¨é‡** | PyBulletåŸç”Ÿå½•åˆ¶è´¨é‡ |
| **å¤§å°** | å…¸å‹è½¨è¿¹ 1-5MB |
| **å¸§ç‡** | ä¸ä»¿çœŸåŒæ­¥ |
| **æ—¶é•¿** | å–å†³äºè½¨è¿¹æ’­æ”¾æ—¶é—´ |

### ğŸš€ å¿«é€Ÿå¼€å§‹

1. **è¿è¡Œåœºæ™¯é€‰æ‹©å™¨**:
   ```bash
   python examples/motion_gen_scene_selector.py
   ```

2. **é€‰æ‹©åœºæ™¯å’Œæ¼”ç¤ºç±»å‹**

3. **é€‰æ‹©å½•åˆ¶**: å½“è¯¢é—®æ˜¯å¦å½•åˆ¶æ—¶é€‰æ‹© `y`

4. **æŸ¥çœ‹ç»“æœ**: ç¨‹åºä¼šæ˜¾ç¤ºè§†é¢‘ä¿å­˜è·¯å¾„

---

**æ€»ç»“**: æ–°å¢çš„è§†é¢‘å½•åˆ¶åŠŸèƒ½ä¸ºmotion_gen_scene_selector.pyæä¾›äº†å®Œæ•´çš„å¯è§†åŒ–è®°å½•èƒ½åŠ›ï¼Œæ–¹ä¾¿ç”¨æˆ·ä¿å­˜å’Œåˆ†äº«è¿åŠ¨è§„åˆ’æ¼”ç¤ºç»“æœï¼Œæ˜¯ä¸€ä¸ªå®ç”¨ä¸”ä¸“ä¸šçš„åŠŸèƒ½æ‰©å±•ï¼ğŸ‰ 